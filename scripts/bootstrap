#!/bin/sh
# ClaudeRLM bootstrap — downloads the binary on first run.
# Called from SessionStart hook; all output goes to stderr
# so it won't interfere with hook JSON on stdout.
set -e

PLUGIN_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
BINARY="${PLUGIN_ROOT}/bin/claude-rlm"
REPO="dullfig/claude-rlm"

# Fast path: binary already exists
if [ -x "$BINARY" ]; then
    exit 0
fi

info() { printf "[claude-rlm] %s\n" "$*" >&2; }

info "First run — downloading claude-rlm binary..."

# Detect platform
detect_platform() {
    local os arch
    os="$(uname -s)"
    arch="$(uname -m)"

    case "$os" in
        Linux)  os="unknown-linux-gnu" ;;
        Darwin) os="apple-darwin" ;;
        *)      info "Unsupported OS: $os"; exit 1 ;;
    esac

    case "$arch" in
        x86_64|amd64)  arch="x86_64" ;;
        aarch64|arm64) arch="aarch64" ;;
        *)             info "Unsupported architecture: $arch"; exit 1 ;;
    esac

    echo "${arch}-${os}"
}

# Get latest release tag from GitHub
get_latest_version() {
    if command -v curl >/dev/null 2>&1; then
        curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest" 2>/dev/null \
            | grep '"tag_name"' | head -1 | sed 's/.*"tag_name": *"//;s/".*//'
    elif command -v wget >/dev/null 2>&1; then
        wget -qO- "https://api.github.com/repos/${REPO}/releases/latest" 2>/dev/null \
            | grep '"tag_name"' | head -1 | sed 's/.*"tag_name": *"//;s/".*//'
    else
        echo ""
    fi
}

platform="$(detect_platform)"
version="$(get_latest_version)"

if [ -z "$version" ]; then
    info "ERROR: Could not determine latest release version."
    info "Check https://github.com/${REPO}/releases and download manually."
    exit 1
fi

url="https://github.com/${REPO}/releases/download/${version}/claude-rlm-${platform}.tar.gz"
tmpdir="$(mktemp -d)"

info "Downloading ${version} for ${platform}..."

if command -v curl >/dev/null 2>&1; then
    curl -fsSL "$url" -o "${tmpdir}/archive.tar.gz"
elif command -v wget >/dev/null 2>&1; then
    wget -q "$url" -O "${tmpdir}/archive.tar.gz"
else
    info "ERROR: Neither curl nor wget found."
    exit 1
fi

tar xzf "${tmpdir}/archive.tar.gz" -C "${tmpdir}"
mkdir -p "${PLUGIN_ROOT}/bin"
mv "${tmpdir}/claude-rlm" "$BINARY"
chmod +x "$BINARY"
rm -rf "$tmpdir"

# Record the installed version
echo "$version" > "${PLUGIN_ROOT}/bin/.version"

info "Installed claude-rlm ${version}"
